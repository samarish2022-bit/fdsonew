# Анализ медленной загрузки изображений

## Найденные причины

### 1. **Нет кэширования статических файлов (картинок)**
- Статика раздаётся через `express.static(__dirname)` без своих заголовков.
- По умолчанию браузер может каждый раз перепроверять файлы, из‑за чего повторные заходы на сайт снова качают все изображения.
- **Решение:** выдавать для папки `images/` заголовок `Cache-Control: public, max-age=...` (например, 1 год для неизменяемых имён файлов).

### 2. **Список фото не кэшируется**
- Запрос к `/api/photos` идёт с `?t=Date.now()` — каждый раз новый URL, кэш не используется.
- Ответ API помечен `Cache-Control: no-store` — браузер не сохраняет ответ.
- В итоге при каждом открытии страницы снова запрашивается `photos.json` и все URL фото.
- **Решение:** убрать `?t=...` при работе с сервером и разрешить короткое кэширование ответа API (например, `max-age=60`), либо не ставить `no-store` для GET `/api/photos`.

### 3. **Один и тот же большой файл для превью и для полного размера**
- В галерее и в карточках соревнований используется один и тот же URL фото (файл до 1200px по ширине, quality 0.75).
- Для маленьких превью (карточка события 48–80px, сетка галереи ~160–280px) всё равно подгружается полный файл.
- Чем больше фото на странице, тем больше лишнего трафика и времени загрузки.
- **Решение (на перспективу):** при загрузке фото сохранять также уменьшенную копию (например, 400px) и в списке событий/сетке подставлять URL превью; полный URL — только для лайтбокса и «открыть в полном размере».

### 4. **Много одновременных запросов**
- На странице события в галерее в DOM сразу выводятся все фото с `src="..."` и `loading="lazy"`.
- Lazy откладывает загрузку только за пределами экрана; те, что попали в первый экран, запрашиваются сразу и параллельно.
- При большом количестве фото это даёт десятки одновременных запросов и конкуренцию за канал.
- **Решение:** оставить `loading="lazy"`; при появлении превью (п.3) подгружать только превью в сетке, полный размер — по клику/открытию в лайтбоксе.

### 5. **Герой-фон на главной**
- `hero-bg.jpg` подключается с `loading="eager"` — это правильно для LCP.
- Если сам файл тяжёлый (например, несколько сотен КБ или мегабайт), первый отклик страницы будет медленным.
- **Решение:** сжать `images/hero-bg.jpg` (оптимизация/конвертация в WebP, уменьшение разрешения до реально используемого в вёрстке).

### 6. **Фото при загрузке через админку**
- Для галереи уже используется сжатие на клиенте: `saveImageToSite(file, 1200, 0.75)` — макс. ширина 1200px, качество 0.75.
- Сервер сохраняет присланный base64 как есть, без повторного сжатия — это нормально при уже сжатых данных с клиента.
- Дополнительно можно на сервере при сохранении фото ресайзить/сжимать (например, через sharp) и сохранять две версии: превью и полную — тогда будет материал для п.3.

---

## Что сделано в коде (быстрые улучшения)

1. **Сервер:** для маршрута `/images` используется `express.static` с `maxAge: '1y'` — браузер кэширует картинки на год.
2. **Сервер:** для GET `/api/photos` вместо `no-store` установлен `Cache-Control: public, max-age=300` (5 минут), чтобы список фото не запрашивался при каждом переходе.
3. **Клиент:** убран cache-buster `?t=Date.now()` при запросе к `/api/photos`, чтобы ответ мог кэшироваться; для fallback на `data/photos.json` cache-buster оставлен.
4. **Разметка:** для картинок в галерее добавлен `decoding="async"`, чтобы декодирование не блокировало основной поток.

---

## Дополнительно реализовано

### Генерация превью при загрузке фото
- При загрузке фото через админку (POST `/api/upload-photo`) сервер создаёт превью с помощью **sharp**: макс. ширина 400px, JPEG quality 82. Файл сохраняется рядом с основным: `{id}-thumb.jpg`.
- В ответе API возвращаются `url` (полное фото) и `thumbUrl` (превью). В `data/photos.json` сохраняются оба поля.

### Отдельный URL для превью в списке/сетке
- В галерее (сетка фото и карточки соревнований) для отображения используется `thumbUrl` (при отсутствии — `url`). Ссылка «открыть в полном размере» и лайтбокс по-прежнему используют `url`.
- В `js/admin.js` при сохранении списка фото в API передаётся и сохраняется поле `thumbUrl`.

### Оптимизация hero-bg
- Скрипт **scripts/optimize-hero.js**: уменьшает `images/hero-bg.jpg` до макс. ширины 1920px (без увеличения), перезаписывает файл и дополнительно создаёт **images/hero-bg.webp** (quality 82). Запуск: `npm run optimize-hero`.
- На главной странице hero выводится через `<picture>`: браузеры с поддержкой WebP получают `hero-bg.webp`, остальные — `hero-bg.jpg`.
